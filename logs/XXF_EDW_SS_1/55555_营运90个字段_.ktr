<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>2_1数据抽取</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2019/04/02 22:43:42.626</created_date>
    <modified_user>-</modified_user>
    <modified_date>2019/04/02 22:43:42.626</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>192.168.0.2_xxfbooks</name>
    <server>192.168.0.2</server>
    <type>MSSQLNATIVE</type>
    <access>Native</access>
    <database>xxfbooks</database>
    <port>1433</port>
    <username>sa</username>
    <password>Encrypted 2edf1dcb11acf97a6a416a5638fcbf689</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQLUseIntegratedSecurity</code>
        <attribute>false</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1433</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>192.168.21.2_cqbooks2</name>
    <server>192.168.21.2</server>
    <type>MSSQLNATIVE</type>
    <access>Native</access>
    <database>cqbooks2</database>
    <port>1433</port>
    <username>tlx</username>
    <password>Encrypted 2be98afc86aa7f2e4cb79ff228dc6fa8c</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQLUseIntegratedSecurity</code>
        <attribute>false</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1433</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>192.168.21.44_XXF_EDW</name>
    <server>192.168.21.44</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>XXF_EDW</database>
    <port>3306</port>
    <username>root</username>
    <password>Encrypted 2be98afc86aa7f2e4cb79ce10cc9da0ce</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>交易笔数(不含少儿与不二)_</from>
      <to>mysql目的端2222 2 2 2</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>贵州交易笔数一级分类 2</from>
      <to>mysql目的端3332 2 2 2</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>mysql目的端2222 2 2 2</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>192.168.21.44_XXF_EDW</connection>
    <schema/>
    <table>cq_not_shaoer_buer</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>680</xloc>
      <yloc>165</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>mysql目的端3332 2 2 2</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>192.168.21.44_XXF_EDW</connection>
    <schema/>
    <table>gz_not_shaoer_buer</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>680</xloc>
      <yloc>261</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>交易笔数(不含少儿与不二)_</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>192.168.21.2_cqbooks2</connection>
    <sql>select a.操作日期,a.站点ID,
sum(a.[交易笔数(不含不二)])'交易笔数(不含不二)',sum(a.[交易笔数(不含少儿与不二)])'交易笔数(不含少儿与不二)',
sum(a.[交易笔数(不二)])'交易笔数(不二)',sum(a.[交易笔数(少儿)])'交易笔数(少儿)',
sum(a.不含不二册数)不含不二册数,sum(a.不含少儿与不二册数)不含少儿与不二册数,sum(a.不二册数)不二册数,sum(a.少儿册数)少儿册数,
sum(a.交易笔数)交易笔数,sum(a.销售册数)销售册数,sum(a.会员交易笔数)会员交易笔数,sum(a.会员销售册数)会员销售册数
from (
-- 交易笔数(不含少儿)
select a.操作日期,a.站点ID,sum(a.[交易笔数(不含不二)])-sum(a.[交易笔数(不含少儿)负值笔数]) as '交易笔数(不含不二)',0 as '交易笔数(不含少儿与不二)'
,0 as '交易笔数(少儿)',0 as '交易笔数(不二)',sum(a.不含不二册数)不含不二册数,0 as '不含少儿与不二册数',0 as '少儿册数',0 as '不二册数'
,0 as '交易笔数',0 as '销售册数',0 as '会员交易笔数',0 as '会员销售册数'
from (

select a.操作日期,a.站点ID,count(*) as '交易笔数(不含不二)',0 as '交易笔数(不含少儿)负值笔数',sum(a.交易册数) as 不含不二册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) not in ('13')
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as '交易笔数(不含少儿与不二)',count(*)*2 as '交易笔数(不含少儿)负值笔数',0 as 'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) not in ('13') and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID





-- 交易笔数(不含少儿与不二)
union all
select a.操作日期,a.站点ID,0 as 'a',sum(a.[交易笔数(不含少儿与不二)])-sum(a.[交易笔数(不含少儿与不二)负值笔数]) as '交易笔数(不含少儿与不二)',0 as '交易笔数(少儿)',0 as '交易笔数(不二)'
    ,0 as 'aaa',sum(a.不含少儿与不二册数)不含少儿与不二册数,0 as 'bbb',0 as 'ccc',0 as 'aaaaa',0 as 'bbbbbb',0 as 'ccccc',0 as 'ddddd' from (
select a.操作日期,a.站点ID,count(*) as '交易笔数(不含少儿与不二)',0 as '交易笔数(不含少儿与不二)负值笔数',sum(a.交易册数) as 不含少儿与不二册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,
sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) not in ('01','13')
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数(不含少儿与不二)负值笔数',0 as 'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) not in ('01','13') and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID


-- 交易笔数(少儿)
union all
select a.操作日期,a.站点ID,0 as 'a',0 as 'b',sum(a.[交易笔数(少儿)])-sum(a.[交易笔数(少儿)负值笔数]) as '交易笔数(少儿)',0 as 'aaa'
,0 as 'c',0 as 'bbb',sum(a.少儿交易册数)少儿交易册数,0 as 'ccc',0 as 'aaaaa',0 as 'bbbbbb',0 as 'ccccc',0 as 'ddddd' from (
select a.操作日期,a.站点ID,count(*) as '交易笔数(少儿)',0 as '交易笔数(少儿)负值笔数',sum(a.交易册数) as 少儿交易册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23)  >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='01'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数(少儿)负值笔数',0 as 'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='01' and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID


-- 交易笔数(不二)
union all
select a.操作日期,a.站点ID,0 as 'a',0 as '交易笔数(少儿)',0 as '交易笔数(不二)',sum(a.[交易笔数(不二)])-sum(a.[交易笔数(不二)负值笔数]) as '交易笔数(不二)'
 ,0 as 'c',0 as 'bbb',0 as 'ccc',sum(a.不二交易册数)不二交易册数,0 as 'aaaaa',0 as 'bbbbbb',0 as 'ccccc',0 as 'ddddd' from (
select a.操作日期,a.站点ID,count(*) as '交易笔数(不二)',0 as '交易笔数(不二)负值笔数',sum(a.交易册数)不二交易册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='13'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数(不二)负值笔数','0'as'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='13' and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID


union all
select a.操作日期,a.站点ID,0 as 'a',0 as '交易笔数(少儿)',0 as '交易笔数(不二)'
 ,0 as 'c',0 as 'bbb',0 as 'ccc',0 as 'dddd',0 as 'ffff',
sum(a.[交易笔数])-sum(a.[交易笔数负值笔数]) as '交易笔数',sum(a.销售册数)销售册数,0 as 'aaaaa',0 as 'ac'
from (
select a.操作日期,a.站点ID,count(*) as '交易笔数',0 as '交易笔数负值笔数',sum(a.交易册数)销售册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) > convert(varchar(50),getdate()-9,23)
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数负值笔数','0'as'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID



union all
select a.操作日期,a.站点ID,0 as 'a',0 as 'az',0 as 'sx',0 as 'dc'
 ,0 as 'c',0 as 'fv',0 as 'gb',0 as 'hn',0 as 'dddd',0 as 'ffff',
sum(a.[交易笔数])-sum(a.[交易笔数负值笔数]) as '会员交易笔数',
sum(a.销售册数)会员销售册数 from (
select a.操作日期,a.站点ID,count(*) as '交易笔数',0 as '交易笔数负值笔数',sum(a.交易册数)销售册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and a.m_id like 'MM%'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数负值笔数','0'as'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and a.total_money&lt;0 and a.m_id like 'MM%'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID
)a
group by a.操作日期,a.站点ID


</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>504</xloc>
      <yloc>165</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>贵州交易笔数一级分类 2</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>192.168.0.2_xxfbooks</connection>
    <sql>select a.操作日期,a.站点ID,
sum(a.[交易笔数(不含不二)])'交易笔数(不含不二)',sum(a.[交易笔数(不含少儿与不二)])'交易笔数(不含少儿与不二)',
sum(a.[交易笔数(不二)])'交易笔数(不二)',sum(a.[交易笔数(少儿)])'交易笔数(少儿)',
sum(a.不含不二册数)不含不二册数,sum(a.不含少儿与不二册数)不含少儿与不二册数,sum(a.不二册数)不二册数,sum(a.少儿册数)少儿册数,
sum(a.交易笔数)交易笔数,sum(a.销售册数)销售册数,sum(a.会员交易笔数)会员交易笔数,sum(a.会员销售册数)会员销售册数
from (
-- 交易笔数(不含少儿)
select a.操作日期,a.站点ID,sum(a.[交易笔数(不含不二)])-sum(a.[交易笔数(不含少儿)负值笔数]) as '交易笔数(不含不二)',0 as '交易笔数(不含少儿与不二)'
,0 as '交易笔数(少儿)',0 as '交易笔数(不二)',sum(a.不含不二册数)不含不二册数,0 as '不含少儿与不二册数',0 as '少儿册数',0 as '不二册数'
,0 as '交易笔数',0 as '销售册数',0 as '会员交易笔数',0 as '会员销售册数'
from (

select a.操作日期,a.站点ID,count(*) as '交易笔数(不含不二)',0 as '交易笔数(不含少儿)负值笔数',sum(a.交易册数) as 不含不二册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) not in ('13')
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as '交易笔数(不含少儿与不二)',count(*)*2 as '交易笔数(不含少儿)负值笔数',0 as 'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) =  convert(varchar(50),getdate()-1,23)
and left(c.h_type,2) not in ('13') and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID





-- 交易笔数(不含少儿与不二)
union all
select a.操作日期,a.站点ID,0 as 'a',sum(a.[交易笔数(不含少儿与不二)])-sum(a.[交易笔数(不含少儿与不二)负值笔数]) as '交易笔数(不含少儿与不二)',0 as '交易笔数(少儿)',0 as '交易笔数(不二)'
    ,0 as 'aaa',sum(a.不含少儿与不二册数)不含少儿与不二册数,0 as 'bbb',0 as 'ccc',0 as 'aaaaa',0 as 'bbbbbb',0 as 'ccccc',0 as 'ddddd' from (
select a.操作日期,a.站点ID,count(*) as '交易笔数(不含少儿与不二)',0 as '交易笔数(不含少儿与不二)负值笔数',sum(a.交易册数) as 不含少儿与不二册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,
sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) not in ('01','13')
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数(不含少儿与不二)负值笔数',0 as 'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) not in ('01','13') and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID


-- 交易笔数(少儿)
union all
select a.操作日期,a.站点ID,0 as 'a',0 as 'b',sum(a.[交易笔数(少儿)])-sum(a.[交易笔数(少儿)负值笔数]) as '交易笔数(少儿)',0 as 'aaa'
,0 as 'c',0 as 'bbb',sum(a.少儿交易册数)少儿交易册数,0 as 'ccc',0 as 'aaaaa',0 as 'bbbbbb',0 as 'ccccc',0 as 'ddddd' from (
select a.操作日期,a.站点ID,count(*) as '交易笔数(少儿)',0 as '交易笔数(少儿)负值笔数',sum(a.交易册数) as 少儿交易册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='01'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数(少儿)负值笔数',0 as 'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='01' and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID


-- 交易笔数(不二)
union all
select a.操作日期,a.站点ID,0 as 'a',0 as '交易笔数(少儿)',0 as '交易笔数(不二)',sum(a.[交易笔数(不二)])-sum(a.[交易笔数(不二)负值笔数]) as '交易笔数(不二)'
 ,0 as 'c',0 as 'bbb',0 as 'ccc',sum(a.不二交易册数)不二交易册数,0 as 'aaaaa',0 as 'bbbbbb',0 as 'ccccc',0 as 'ddddd' from (
select a.操作日期,a.站点ID,count(*) as '交易笔数(不二)',0 as '交易笔数(不二)负值笔数',sum(a.交易册数)不二交易册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='13'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数(不二)负值笔数','0'as'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and left(c.h_type,2) ='13' and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID


union all
select a.操作日期,a.站点ID,0 as 'a',0 as '交易笔数(少儿)',0 as '交易笔数(不二)'
 ,0 as 'c',0 as 'bbb',0 as 'ccc',0 as 'dddd',0 as 'ffff',
sum(a.[交易笔数])-sum(a.[交易笔数负值笔数]) as '交易笔数',sum(a.销售册数)销售册数,0 as 'aaaaa',0 as 'ac'
from (
select a.操作日期,a.站点ID,count(*) as '交易笔数',0 as '交易笔数负值笔数',sum(a.交易册数)销售册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数负值笔数','0'as'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and a.total_money&lt;0
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID



union all
select a.操作日期,a.站点ID,0 as 'a',0 as 'az',0 as 'sx',0 as 'dc'
 ,0 as 'c',0 as 'fv',0 as 'gb',0 as 'hn',0 as 'dddd',0 as 'ffff',
sum(a.[交易笔数])-sum(a.[交易笔数负值笔数]) as '会员交易笔数',
sum(a.销售册数)会员销售册数 from (
select a.操作日期,a.站点ID,count(*) as '交易笔数',0 as '交易笔数负值笔数',sum(a.交易册数)销售册数 from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and a.m_id like 'MM%'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
union all
select a.操作日期,a.站点ID,0 as 'a',count(*)*2 as '交易笔数负值笔数','0'as'aa' from (
select convert(varchar(50),a.ls_datetime,23) as 操作日期,a.ls_id as 单据号,a.station_id as 站点ID,sum(h_amount) as 交易册数
from db_ls a
left join  db_ls_item b
on a.ls_id=b.ls_id
left join  db_product c
on b.h_id=c.h_id
where convert(varchar(50),a.ls_datetime,23) >convert(varchar(50),getdate()-9,23)
and a.total_money&lt;0 and a.m_id like 'MM%'
group by a.ls_id,a.station_id,convert(varchar(50),a.ls_datetime,23)
)a group by a.操作日期,a.站点ID
)a group by a.操作日期,a.站点ID
)a
group by a.操作日期,a.站点ID


</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>504</xloc>
      <yloc>261</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
